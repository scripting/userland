<?xml version="1.0" encoding="ISO-8859-1"?>
<!-- OPML generated by OPML Editor v10.1b19 on Fri, 02 Jun 2017 19:48:20 GMT -->
<opml version="2.0">
	<head>
		<title>workspace.userlandSamples.savePagesFilter.savePages</title>
		<dateCreated>Wed, 03 Feb 2010 15:35:51 GMT</dateCreated>
		<dateModified>Fri, 02 Jun 2017 19:48:20 GMT</dateModified>
		<ownerName>Dave Winer</ownerName>
		<ownerId>http://davewiner.com/</ownerId>
		<expansionState>1, 2, 3, 7, 18</expansionState>
		<vertScrollState>1</vertScrollState>
		<windowTop>160</windowTop>
		<windowLeft>692</windowLeft>
		<windowBottom>911</windowBottom>
		<windowRight>1524</windowRight>
		</head>
	<body>
		<outline text="on savePages (pta)">
			<outline text="Changes" isComment="true">
				<outline text="2/3/10; 11:36:10 AM by DW">
					<outline text="Install this script in user.webserver.postFilters. It will create a folder in the ops sub-folder of your Guest Databases folder that contains images of each of the pages or objects that are requested of the built-in web server. It also creates a table of data in user.savePagesFilter that makes it possible to create redirects to those pages. "/>
					<outline text="The purpose is to help &quot;static-ize&quot; a dynamic Manila site or some other app running in Frontier or the OPML Editor."/>
					</outline>
				</outline>
			<outline text="local (adrdata = @user.savePagesFilter, pc = file.getpathchar (), now = clock.now ())"/>
			<outline text="bundle //init">
				<outline text="if not defined (adrdata^)">
					<outline text="new (tabletype, adrdata)"/>
					</outline>
				<outline text="if not defined (adrdata^.prefs)">
					<outline text="new (tabletype, @adrdata^.prefs)"/>
					</outline>
				<outline text="if not defined (adrdata^.prefs.folder)">
					<outline text="adrdata^.prefs.folder = frontier.getsubfolder (&quot;ops&quot;) + &quot;saved pages&quot; + pc"/>
					</outline>
				<outline text="if not defined (adrdata^.prefs.enabled)">
					<outline text="adrdata^.prefs.enabled = true"/>
					</outline>
				<outline text="if not defined (adrdata^.redirects)">
					<outline text="new (tabletype, @adrdata^.redirects)"/>
					</outline>
				<outline text="if not defined (adrdata^.savedParams)">
					<outline text="new (tabletype, @adrdata^.savedParams)"/>
					</outline>
				<outline text="if not defined (adrdata^.stats)">
					<outline text="new (tabletype, @adrdata^.stats)"/>
					</outline>
				<outline text="if not defined (adrdata^.stats.cthits)">
					<outline text="adrdata^.stats.cthits = 0"/>
					</outline>
				<outline text="if not defined (user.webserver.prefs.MIME2ext) //running in Frontier or Radio">
					<outline text="user.webserver.prefs.MIME2ext = workspace.userlandSamples.savePagesFilter.data.MIME2ext"/>
					</outline>
				</outline>
			<outline text="if adrdata^.prefs.enabled">
				<outline text="if (pta^.code == 200) and (string.upper (pta^.method) == &quot;GET&quot;)">
					<outline text="local (url = string.nthfield (pta^.firstline, &quot; &quot;, 2))"/>
					<outline text="url = string.nthfield (url, &quot;?&quot;, 1)"/>
					<outline text="url = string.replaceall (url, &quot;/$&quot;, &quot;/&quot;) //we keep getting requests with this weird string in it"/>
					<outline text="local (sourceurl = url, desturl = url, host = &quot;&quot;)"/>
					<outline text="adrdata^.params = pta^ //debugging" isComment="true"/>
					<outline text="bundle //set the file extension">
						<outline text="try">
							<outline text="if not (desturl contains &quot;.&quot;)">
								<outline text="local (type = pta^.responseHeaders.[&quot;Content-Type&quot;])"/>
								<outline text="if (desturl endswith &quot;/&quot;) or (desturl == &quot;&quot;)">
									<outline text="desturl = desturl + &quot;index.&quot; + user.webserver.prefs.MIME2ext.[type]"/>
									</outline>
								<outline text="else">
									<outline text="desturl = desturl + &quot;.&quot; + user.webserver.prefs.MIME2ext.[type]"/>
									</outline>
								</outline>
							</outline>
						</outline>
					<outline text="if defined (pta^.host)" isComment="true">
						<outline text="if sizeof (pta^.host) &gt; 0">
							<outline text="host = pta^.host + pc"/>
							</outline>
						</outline>
					<outline text="local (f = adrdata^.prefs.folder + pta^.host + string.replaceall (desturl, &quot;/&quot;, pc))"/>
					<outline text="if not file.exists (f)">
						<outline text="file.surefilepath (f)"/>
						<outline text="file.writewholefile (f, pta^.responsebody)"/>
						</outline>
					<outline text="bundle //save info about redirect">
						<outline text="local (adrtable = @adrdata^.redirects.[pta^.host])"/>
						<outline text="if not defined (adrtable^)">
							<outline text="new (tabletype, adrtable)"/>
							</outline>
						<outline text="adrtable = @adrtable^.[sourceurl]"/>
						<outline text="if not defined (adrtable^)">
							<outline text="new (tabletype, adrtable)"/>
							<outline text="adrtable^.ct = 0"/>
							</outline>
						<outline text="adrtable^.f = f"/>
						<outline text="adrtable^.ct++"/>
						<outline text="adrtable^.when = now"/>
						<outline text="" isComment="true"/>
						<outline text="adrdata^.redirects.[&quot;http://&quot; + string.replaceall (host, pc, &quot;/&quot;) + sourceuri] = f" isComment="true"/>
						</outline>
					<outline text="adrdata^.stats.cthits++"/>
					<outline text="adrdata^.stats.whenLastHit = now"/>
					</outline>
				</outline>
			</outline>
		<outline text="bundle //test code">
			<outline text="savepages (@user.savePagesFilter.savedParams.[&quot;00028&quot;])"/>
			</outline>
		</body>
	</opml>
