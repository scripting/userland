<?xml version="1.0" encoding="ISO-8859-1"?>
<!-- OPML generated by OPML Editor v10.1b19 on Fri, 02 Jun 2017 19:48:21 GMT -->
<opml version="2.0">
	<head>
		<title>workspace.userlandSamples.smallPictRedirect</title>
		<dateCreated>Tue, 28 Jan 2014 16:16:41 GMT</dateCreated>
		<dateModified>Fri, 02 Jun 2017 19:48:21 GMT</dateModified>
		<ownerName>Dave Winer</ownerName>
		<ownerId>http://davewiner.com/</ownerId>
		<expansionState>1, 2, 3, 5, 8, 9, 12, 25, 27, 29</expansionState>
		<vertScrollState>1</vertScrollState>
		<windowTop>203</windowTop>
		<windowLeft>861</windowLeft>
		<windowBottom>988</windowBottom>
		<windowRight>1822</windowRight>
		</head>
	<body>
		<outline text="on smallPictRedirect (pta)">
			<outline text="Changes" isComment="true">
				<outline text="1/28/14; 12:34:12 PM by DW">
					<outline text="Added stats."/>
					</outline>
				<outline text="1/28/14; 12:07:01 PM by DW">
					<outline text="A redirector that works for smallpict.com with the new way our &quot;database&quot; works.">
						<outline text="Every named outline is represented by a JSON file in a folder in an S3 bucket."/>
						<outline text="If it contains a urlRedirect entry, we redirect through it."/>
						<outline text="Here's an example of a file:">
							<outline text="http://beta.fargo.io/data/names/hellodere.json"/>
							</outline>
						</outline>
					<outline text="As with all sample code, it may have some techniques you find useful.">
						<outline text="It also serves to document the new technique in case anyone is interested."/>
						</outline>
					<outline text="To install it, cmd-/ on the line below:">
						<outline text="config.mainresponder.callbacks.hostNotFound.smallPict = @workspace.userlandSamples.smallPictRedirect">
							<outline text="@workspace.userlandSamples.smallPictRedirect" isComment="true"/>
							</outline>
						</outline>
					</outline>
				</outline>
			<outline text="local (lowerhost = string.lower (pta^.host), startticks = clock.ticks ())"/>
			<outline text="if lowerhost endswith &quot;smallpict.com&quot;">
				<outline text="local (name = string.nthfield (lowerhost, &quot;.&quot;, 1))"/>
				<outline text="local (s3url = &quot;http://beta.fargo.io/data/names/&quot; + name + &quot;.json&quot;)"/>
				<outline text="local (jsontext = tcp.httpreadurl (s3url, 3, false))"/>
				<outline text="json.compile (jsontext, @xstruct)"/>
				<outline text="scratchpad.xstruct = xstruct" isComment="true"/>
				<outline text="local (urlRedirect = xml.getvalue (@xstruct, &quot;urlRedirect&quot;))"/>
				<outline text="urlRedirect = string.replace (urlRedirect, &quot;tmp.fargo.io&quot;, &quot;beta.fargo.io&quot;) //1/28/14 by DW"/>
				<outline text=""/>
				<outline text="local (path = pta^.path)"/>
				<outline text="if path beginswith &quot;/&quot;">
					<outline text="path = string.delete (path, 1, 1)"/>
					</outline>
				<outline text="webserver.redirect (pta, urlRedirect + path)"/>
				<outline text=""/>
				<outline text="bundle //stats">
					<outline text="local (adrstats = @scratchpad.smallPictRedirectStats)"/>
					<outline text="if not defined (adrstats^)">
						<outline text="new (tabletype, adrstats)"/>
						</outline>
					<outline text="if not defined (adrstats^.ctRedirects)">
						<outline text="adrstats^.ctRedirects = 0"/>
						</outline>
					<outline text="adrstats^.ctRedirects++"/>
					<outline text="adrstats^.lastSource = &quot;http://&quot; + pta^.host + &quot;/&quot; + path"/>
					<outline text="adrstats^.lastDest = urlRedirect + path"/>
					<outline text="adrstats^.whenLastRedirect = clock.now ()"/>
					<outline text="adrstats^.ctSecs = double (clock.ticks () - startticks) / 60"/>
					</outline>
				<outline text=""/>
				</outline>
			</outline>
		<outline text="bundle //test code" isComment="true">
			<outline text="local (pagetable)"/>
			<outline text="new (tabletype, @pagetable)"/>
			<outline text="pagetable.host = &quot;hellodere.smallpict.com&quot;"/>
			<outline text="pagetable.path = &quot;/rss.xml&quot;"/>
			<outline text="smallPictRedirect (@pagetable)"/>
			</outline>
		</body>
	</opml>
